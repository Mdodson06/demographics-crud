<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Demographics Form</title>
    <!--JS called within this html page-->
    <script>
        displayDemographic();
        async function submitDemographic(event) {
        event.preventDefault();
        const form = document.getElementById('demographicsForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        /*formData.get("firstName")
        formData.get("lastName")
        formData.get("age")
        formData.get("email")
        formData.get("gender")
        formData.get("city")
         */
        isValid = true;
        if (formData.get("firstName").length < 2) {
            document.getElementById('fNameError').innerHTML ='&nbsp; 2 characters required';
            isValid = false;
        } else {
            document.getElementById('fNameError').innerHTML ='&nbsp;';
        }

        if (formData.get("lastName").length < 2) {
            document.getElementById('lNameError').innerHTML ='&nbsp; 2 characters required';
            isValid = false;
        } else {
            document.getElementById('lNameError').innerHTML ='&nbsp;';
        }

        const age = formData.get("age");
        if (age != '' && (age < 0)){
            document.getElementById("ageError").innerHTML = "&nbsp; If included, age must be a positive number";
            isValid= false;
        } else {
            document.getElementById('ageError').innerHTML = '&nbsp;';
        }

        const emailPattern = /^[^ ]+@[^ ]+\.[a-z]{2,3}$/; 
        if (!emailPattern.test(formData.get("email"))) {
            document.getElementById('emailError').innerHTML ='&nbsp; email required';            
            isValid = false;
        } else {
            document.getElementById('emailError').innerHTML ='&nbsp;';
        }

        if(isValid){
            const response = await fetch('/api/demographics', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
            });
            const result = await response.json();
            alert(result.message || 'Submitted successfully!'); 
            displayDemographic();
        } 
    }
    async function displayDemographic() {
        const response = await fetch('/api/demographics', {
            method: 'GET',
            headers: {
            'Content-Type': 'application/json'
            }})
            .then(response => response.json())
            .then(json => {
                //var radr = JSON.stringify(json);
                const jsonArray = Object.values(json);
                const obs = Object.keys(jsonArray[0]);
                var htmlText = '<table> <tr>';
                for (let i = 0; i < obs.length; i++) {
                    htmlText += '<th>' + obs[i] + '</th>';
                }
                htmlText += '</tr>'
//Object.values(jsonArray[i]);
                for (let i = 0; i < jsonArray.length; i++) {
                    //jsonArray is array version of the json
                    //jsonArray iterates through each line
                    var row = Object.values(jsonArray[i]);
                    htmlText += '<tr>'
                    for (let j = 0; j < row.length; j++) {
                        htmlText += '<td>' + row[j] + '</td>';                        
                    }
                    htmlText +="</tr>"
                }
                htmlText += "</table>"
                document.getElementById("display").innerHTML = htmlText;
            });
    }
    
    </script>
</head>
<body>
    <div id="full">
    <h1 id="header">Demographics Form</h1>
    <div id="content">
    <div id="form">
    <form id="demographicsForm" onsubmit="submitDemographic(event)">
        <div class="question">
            <label for="firstName">First Name:</label>
            <input type="text" name="firstName" id="firstName" required>
        </div>
        <small id="fNameError" style="color: red;">&nbsp;</small>
        <br><br>

        <div class="question">
            <label for="lastName">Last Name:</label>
            <input type="text" name="lastName" id="firstName" required>
        </div>
        <small id="lNameError" style="color: red;">&nbsp;</small>
        <br><br>

        <div class="question">
            <label for="age">Age:</label>
            <input type="number" name="age" id="age" required>
        </div>
        <small id="ageError" style="color: red;">&nbsp;</small>
        <br><br>

        <div class="question">
            <label for="email">Email:</label>
            <input type="email" name="email" id="email" required>
        </div>
        <small id="emailError" style="color: red;">&nbsp;</small>
        <br><br>

        <div class="question">
            <label for="gender">Gender:</label>
            <input type="text" name="gender" id="gender" required>
        </div>
        <small id="genderError" style="color: red;">&nbsp;</small>
        <br><br>

        <div class="question">
            <label for="city">City:</label> 
            <input type="text" name="city" id="city" required>
        </div>
        <small id="cityError" style="color: red;">&nbsp;</small>
        <br><br>

        <button type="submit">Submit</button>
    </form>
    </div>
    <div id="display">
        <table></table>
    </div>
    </div>
    <p id="footer">Insert copyright info here</p>
    </div>
</body>
</html> 